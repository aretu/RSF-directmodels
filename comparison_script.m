% close all

overlaydata=true;
savefigure=true;

% %% the old way to do it
% 
% % comparison_list={
% % 'b-mcf-simple_complex-alpha_00_03-epsilon_000017',...
% % 'b-mcf-simple_simplesh-alpha_00_03-epsilon_000017',...
% % 'b-mcf-simple_complex-alpha_00-epsilon_000017_000000',...
% % 'b-mcf-simple_complex-alpha_00-epsilon_000000-difftime_000001_001000_010000_100000',...
% % 'b-mcf-simple_complex-alpha_00-epsilon_000017-difftime_000001_001000_010000_100000',...
% % 'b-mcf-simple_complex-alpha_03-epsilon_000017-k_10_09',...
% % 'b-mcf-simple_complex-alpha_00-epsilon_000017-k_10_09',...
% % 'b-mcf-simple-alpha_00_03-epsilon_000000_000017-xi_066_075',...
% % 'b-mcf-complex-alpha_00_03-epsilon_000000_000017-xi_066_075-difftime_000001',...
% % 'b-mcf-complex-alpha_00_03-epsilon_000017-beta_1e-6_1e-10_1e-11',...
% % 'b-mcf-simple_complex-alpha_00_03-epsilon_000000_000017',...
% % 's-mcf-simple_complex-alpha_00-epsilon_000017',...
% % 's-mcf-complex-alpha_00_03-epsilon_000017-beta_1e-06_1e-10_1e-11',...
% % 's-bg-simple_complex-alpha_00_03-epsilon_000000_000017',...
% % 's-bg-complex-alpha_00-epsilon_000000-beta_1e-09_1e-10_1e-11_1e-12',...
% % 's-mcf-simple_complex-alpha_00_03-epsilon_000000_000017',...
% % 's-mcf-complex-alpha_00-epsilon_000000-beta_1e-09_1e-10_1e-11_1e-12',...
% % };
% 
% comparison_list={
%     % 'b-mcf-simple_complex-alpha_00_03-epsilon_000000_000017',...
%     % 's-bg-simple_complex-alpha_00_03-epsilon_000000_000017',...
%     % 's-mcf-simple_complex-alpha_00_03-epsilon_000000_000017',...
%     'final models shiva bg',...
%     'final models shiva mcf',...
%     'final models brava mcf'
%     };
% 
% 
% 
% for j=1:size(comparison_list,2)
%     close all
%     comparison=comparison_list{j};
% 
%     switch comparison
%         case 'b-mcf-simple_complex-alpha_00_03-epsilon_000017'
%             compare=[
%                 "mcf-066-02-03-000017-s",...
%                 "mcf-066-02-03-000017-000001-c",...
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-00-000017-000001-c"
%                 ];
%             data='brava';
% 
%         case 'b-mcf-simple_simplesh-alpha_00_03-epsilon_000017'
%             compare=[
%                 "mcf-066-02-03-000017-s",...
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-03-000017-ssh",...
%                 "mcf-066-02-00-000017-ssh"
%                 ];
%             data='brava';
% 
%         case 'b-mcf-simple_complex-alpha_00-epsilon_000017_000000'
%             compare=[
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-00-000000-s",...
%                 "mcf-066-02-00-000017-000001-c",...
%                 "mcf-066-02-00-000000-000001-c"
%                 ];
%             % nulla cambia
%             data='brava';
% 
%         case 'b-mcf-simple_complex-alpha_00-epsilon_000000-difftime_000001_001000_010000_100000'
%             compare=[
%                 "mcf-066-02-00-000000-s",...
%                 "mcf-066-02-00-000000-000001-c",...
%                 "mcf-066-02-00-000000-001000-c",...
%                 "mcf-066-02-00-000000-010000-c",...
%                 "mcf-066-02-00-000000-100000-c"
%                 ];
%             %result: all complex are identical ln(V/VR)=-8.6
%             data='brava';
% 
%         case 'b-mcf-simple_complex-alpha_00-epsilon_000017-difftime_000001_001000_010000_100000'
%             compare=[
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-00-000017-000001-c",...
%                 "mcf-066-02-00-000017-001000-c",...
%                 "mcf-066-02-00-000017-010000-c",...
%                 "mcf-066-02-00-000017-100000-c"
%                 ];
%             %result: all complex are identical ln(V/VR)=-10
%             data='brava';
% 
%         case 'b-mcf-simple_complex-alpha_03-epsilon_000017-k_10_09'
%             compare=[
%                 "mcf-066-02-03-000017-s",...
%                 "mcf-066-02-03-000017-09k-s",...
%                 "mcf-066-02-03-000017-000001-c",...
%                 "mcf-066-02-03-000017-000001-09k-c"
%                 ];
%             %result: all identical
%             data='brava';
% 
%         case 'b-mcf-simple_complex-alpha_00-epsilon_000017-k_10_09'
%             compare=[
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-00-000017-09k-s",...
%                 "mcf-066-02-00-000017-000001-c",...
%                 "mcf-066-02-00-000017-000001-09k-c"
%                 ];
%             %result: all identical
%             data='brava';
% 
%         case 'b-mcf-simple-alpha_00_03-epsilon_000000_000017-xi_066_075'
%             compare=[
%                 "mcf-075-02-03-000017-s",...
%                 "mcf-075-02-00-000017-s",...
%                 "mcf-075-02-03-000000-s",...
%                 "mcf-075-02-00-000000-s",...
%                 "mcf-066-02-03-000017-s",...
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-03-000000-s",...
%                 "mcf-066-02-00-000000-s"
%                 ];
%             data='brava';
% 
%         case 'b-mcf-complex-alpha_00_03-epsilon_000000_000017-xi_066_075-difftime_000001'
%             compare=[
%                 "mcf-066-02-03-000017-000001-c",...
%                 "mcf-066-02-00-000017-000001-c",...
%                 "mcf-066-02-03-000000-000001-c",...
%                 "mcf-066-02-00-000000-000001-c",...
%                 "mcf-075-02-03-000017-000001-c",...
%                 "mcf-075-02-00-000017-000001-c",...
%                 "mcf-075-02-03-000000-000001-c",...
%                 "mcf-075-02-00-000000-000001-c"
%                 ];
%             data='brava';
% 
%         case 'b-mcf-simple_complex-alpha_00_03-epsilon_000000_000017'
%             compare=[
%                 "mcf-066-02-03-000017-s",...
%                 "mcf-066-02-00-000017-s",...
%                 "mcf-066-02-03-000000-s",...
%                 "mcf-066-02-00-000000-s",...
%                 'mcf-066-02-03-000017-000001-2E-12-c',...
%                 'mcf-066-02-00-000017-000001-2E-12-c',...
%                 'mcf-066-02-03-000000-000001-2E-12-c',...
%                 'mcf-066-02-00-000000-000001-2E-12-c',...
%                 ];
%             data='brava';
% 
%         case 'b-mcf-complex-alpha_00_03-epsilon_000017-beta_1e-6_1e-10_1e-11'
%             compare=[
%                 "mcf-066-02-03-000017-000001-c",...
%                 "mcf-066-02-00-000017-000001-c",...
%                 "mcf-066-02-03-000017-000001-1e-06-c",...
%                 "mcf-066-02-00-000017-000001-1e-06-c",...
%                 "mcf-066-02-03-000017-000001-1e-10-c",...
%                 "mcf-066-02-00-000017-000001-1e-10-c",...
%                 "mcf-066-02-03-000017-000001-1e-11-c",...
%                 "mcf-066-02-00-000017-000001-1e-11-c"
%                 ];
%             data='s1949';
% 
%         case 's-mcf-simple_complex-alpha_00-epsilon_000017'
%             compare=[
%                 "mcf-042-01-03-000017-s",...
%                 "mcf-042-01-00-000017-s",...
%                 "mcf-042-01-03-000017-000001-1e-06-c",...
%                 "mcf-042-01-00-000017-000001-1e-06-c"
%                 ];
%             data='s1949';
% 
%         case 's-mcf-complex-alpha_00_03-epsilon_000017-beta_1e-06_1e-10_1e-11'
%             compare=[
%                 "mcf-042-01-03-000017-000001-1e-06-c",...
%                 "mcf-042-01-00-000017-000001-1e-06-c",...
%                 "mcf-042-01-03-000017-000001-1e-10-c",...
%                 "mcf-042-01-00-000017-000001-1e-10-c",...
%                 "mcf-042-01-03-000017-000001-1e-11-c",...
%                 "mcf-042-01-00-000017-000001-1e-11-c"
%                 ];
%             data='s1949';
% 
%         case 's-bg-simple_complex-alpha_00_03-epsilon_000000_000017'
%             compare=[
%                 % "bg-045-01-03-000017-s",...
%                 % "bg-045-01-00-000017-s",...
%                 % "bg-045-01-03-000017-c",...
%                 % "bg-045-01-00-000017-c",...
%                 % "bg-045-01-03-000000-s",...
%                 % "bg-045-01-00-000000-s",...
%                 % "bg-045-01-03-000000-c",...
%                 % "bg-045-01-00-000000-c",...
%                 "bg-048-01-03-000017-s",...
%                 "bg-048-01-00-000017-s",...
%                 "bg-048-01-03-000017-c",...
%                 "bg-048-01-00-000017-c",...
%                 "bg-048-01-03-000000-s",...
%                 "bg-048-01-00-000000-s",...
%                 "bg-048-01-03-000000-c",...
%                 "bg-048-01-00-000000-c",...
%                 ];
%             data='s1997';
% 
%         case 's-bg-complex-alpha_00-epsilon_000000-beta_1e-09_1e-10_1e-11_1e-12'
%             compare=[
%                 "bg-045-01-00-000000-000001-1e-12-c",...
%                 "bg-045-01-00-000000-000001-1e-11-c",...
%                 "bg-045-01-00-000000-000001-1e-10-c",...
%                 "bg-045-01-00-000000-000001-1e-09-c",...
%                 ];
%             data='s1997';
% 
%         case 's-mcf-simple_complex-alpha_00_03-epsilon_000000_000017'
%             compare=[
%                 % "mcf-042-01-03-000017-s",...
%                 % "mcf-042-01-00-000017-s",...
%                 % "mcf-042-01-03-000017-c",...
%                 % "mcf-042-01-00-000017-c",...
%                 % "mcf-042-01-03-000000-s",...
%                 % "mcf-042-01-00-000000-s",...
%                 % "mcf-042-01-03-000000-c",...
%                 % "mcf-042-01-00-000000-c",...
%                 "mcf-055-01-03-000017-s",...
%                 "mcf-055-01-00-000017-s",...
%                 "mcf-055-01-03-000017-c",...
%                 "mcf-055-01-00-000017-c",...
%                 "mcf-055-01-03-000000-s",...
%                 "mcf-055-01-00-000000-s",...
%                 "mcf-055-01-03-000000-c",...
%                 "mcf-055-01-00-000000-c",...
%                 ];
%             data='s1949';
% 
%         case 's-mcf-complex-alpha_00-epsilon_000000-beta_1e-09_1e-10_1e-11_1e-12'
%             compare=[
%                 "mcf-042-01-00-000000-000001-1e-12-c",...
%                 "mcf-042-01-00-000000-000001-1e-11-c",...
%                 "mcf-042-01-00-000000-000001-1e-10-c",...
%                 "mcf-042-01-00-000000-000001-1e-09-c",...
%                 ];
%             data='s1949';
% 
%         case 'final models shiva bg'
%             compare=[
%                 'bg-048-01-03-000017-1a',...
%                 'bg-048-01-00-000017-1a',...
%                 'bg-048-01-03-000017-000001-2E-12-2a',...
%                 'bg-048-01-00-000017-000001-2E-12-2a',...
%                 'bg-048-01-03-000017-000001-2E-12-2b',...
%                 'bg-048-01-00-000017-000001-2E-12-2b',...
%                 'bg-048-01-03-000000-1a',...
%                 'bg-048-01-00-000000-1a',...
%                 'bg-048-01-03-000000-000001-2E-12-2a',...
%                 'bg-048-01-00-000000-000001-2E-12-2a',...
%                 'bg-048-01-03-000000-000001-2E-12-2b',...
%                 'bg-048-01-00-000000-000001-2E-12-2b',...
% 
%                 ];
% 
%         case 'final models shiva mcf'
%             compare=[
%                 'mcf-055-01-03-000017-1a',...
%                 'mcf-055-01-00-000017-1a',...
%                 'mcf-055-01-03-000017-000001-2E-12-2a',...
%                 'mcf-055-01-00-000017-000001-2E-12-2a',...
%                 'mcf-055-01-03-000017-000001-2E-12-2b',...
%                 'mcf-055-01-00-000017-000001-2E-12-2b',...
%                 'mcf-055-01-03-000000-1a',...
%                 'mcf-055-01-00-000000-1a',...
%                 'mcf-055-01-03-000000-000001-2E-12-2a',...
%                 'mcf-055-01-00-000000-000001-2E-12-2a',...
%                 'mcf-055-01-03-000000-000001-2E-12-2b',...
%                 'mcf-055-01-00-000000-000001-2E-12-2b',...
% 
%                 ];
% 
%         case 'final models brava mcf'
%             compare=[
%                 'mcf-066-02-03-000017-1a',...
%                 'mcf-066-02-00-000017-1a',...
%                 'mcf-066-02-03-000017-000001-2E-12-2a',...
%                 'mcf-066-02-00-000017-000001-2E-12-2a',...
%                 'mcf-066-02-03-000017-000001-2E-12-2b',...
%                 'mcf-066-02-00-000017-000001-2E-12-2b',...
%                 'mcf-066-02-03-000000-1a',...
%                 'mcf-066-02-00-000000-1a',...
%                 'mcf-066-02-03-000000-000001-2E-12-2a',...
%                 'mcf-066-02-00-000000-000001-2E-12-2a',...
%                 'mcf-066-02-03-000000-000001-2E-12-2b',...
%                 'mcf-066-02-00-000000-000001-2E-12-2b',...
%                 ];
% 
%     end

    %% test to query and populate the comparison
    close all
    clear qc compare

    % build query qc
    qc.material="bg";
    qc.machine="shiva";
    qc.xi=[0.48];
    qc.alpha=[0,0.3];
    qc.epsilon=[0,1.7e-4];
    % qc.crpinj_modtype=["simple","complex"];
    qc.beta_1_Pa_=[0,2e-12];
    qc.model_type=["1a","2a","2b"];

    % get list of experiments using the query qc

    compare=query_table_dynamically('inputparameters.xlsx',qc);

    % encode qc into a descriptive string

    % Specify which fields to include (optional)
    fields_to_include = {'material', 'machine', 'alpha', 'epsilon', 'model_type'};

    % Initialize an empty cell array to hold the parts of the string
    strings = {};

    % Loop over all fields in qc
    all_fields = fieldnames(qc);
    for i = 1:numel(all_fields)
        field_name = all_fields{i};

        % If you're filtering to include only specific fields
        if ~isempty(fields_to_include) && ~ismember(field_name, fields_to_include)
            continue;  % Skip this field if not in the inclusion list
        end

        % Get the value of the field
        field_value = qc.(field_name);

        % Handle different data types
        if ischar(field_value) || isstring(field_value)
            % If it's a string or char, combine field name and value
            strings{end+1} = strcat(field_name, '_', char(strjoin(cellstr(string(field_value)), '_')));

        elseif isnumeric(field_value)
            % If it's a numeric array, join its elements with '_', and add field name
            strings{end+1} = strcat(field_name, '_', char(strjoin(string(field_value), '_')));

        elseif iscell(field_value)
            % If it's a cell array, join its contents (assuming strings) with '_', and add field name
            strings{end+1} = strcat(field_name, '_', char(strjoin(string(field_value), '_')));

        else
            % If it's another type, you can define how to handle it or skip
            warning('Unrecognized field type for %s. Skipping.', field_name);
            continue;
        end
    end

    % Ensure the strings are converted to character vectors for strjoin
    comparison = strjoin(strings, '-');

    % Display the final comparison string
    disp(comparison);



    %%
    for i=1:size(compare,2)

        name=char(compare(1,i));

        parameters=get_parameters(name);

        globaloutput=load(['results\',name,'model.mat']);
        globaloutput=globaloutput.globaloutput;

        plotter(globaloutput,parameters);
        hold on

        comparison_plotter(globaloutput,parameters);
        hold on

    end

    %% save one figure of interest
    fig=figure(3);
    fig.Units = 'normalized';
    fig.OuterPosition=[0 0 1 1];

    for i=1:size(fig.Children,1)
        if fig.Children(i).Type == "axes"
            gca=fig.Children(i);
            gca.FontSize=20;
            gca.FontName='Arial';

            % for l=1:size(gca.Children,1)
            %     gca.Children(l).LineStyle='-';
            %     gca.Children(l).LineWidth=2;
            % end
        end
    end

    yyaxis left
    colororder("sail")
    gca.YColor='k';
    yllims=gca.YLim;
    xlims=gca.XLim;

    yyaxis right
    gca.YColor='k';
    delete(gca.Children(2:end))
    gca.Children(1).LineStyle='-';
    gca.Children(1).LineWidth=2;
    gca.Children(1).Color='k';
    gca.Children(1).DisplayName='Pf';
    gca.Children(1).Marker="none";
    yrlims=gca.YLim;

    title(comparison,'Interpreter','none')

    legend(Location="north",FontSize=14)

    %% overlay corresponding data
    data=char(parameters.data);

    if true(overlaydata)
        switch data
            case 'brava'
                dataoverlayer(['G:\My Drive\Stefano\Ricerca\Collaborations\2020_FEAR\fluid injection SHIVA BRAVA\data\jupyter\',data],1402.5-496.4,parameters)
                % dataoverlayer(['G:\Il Mio Drive\Stefano\Ricerca\Collaborations\2020_FEAR\fluid injection SHIVA BRAVA\data\jupyter\',data],711,parameters)

            case 's1949'
                dataoverlayer(['G:\My Drive\Stefano\Ricerca\Collaborations\2020_FEAR\fluid injection SHIVA BRAVA\data\jupyter\',data],711,parameters)
                % dataoverlayer(['G:\Il Mio Drive\Stefano\Ricerca\Collaborations\2020_FEAR\fluid injection SHIVA BRAVA\data\jupyter\',data],711,parameters)
            case 's1997'
                dataoverlayer(['G:\My Drive\Stefano\Ricerca\Collaborations\2020_FEAR\fluid injection SHIVA BRAVA\data\jupyter\',data],4446.7,parameters)
                % dataoverlayer(['G:\Il Mio Drive\Stefano\Ricerca\Collaborations\2020_FEAR\fluid injection SHIVA BRAVA\data\jupyter\',data],4446.7,parameters)
        end
    end

    yyaxis left
    ylim([yllims(1),12])
    xlim(xlims)
    yyaxis right
    ylim(yrlims)

    %% possible savefigure function

    fig.Renderer="painters";

    if true(savefigure)
        if true(overlaydata)
            savefig(fig,['comparetodata\plots\',comparison,'_.fig'])
            saveas(fig,['comparetodata\plots\',comparison,'.svg'])
            saveas(fig,['comparetodata\plots\',comparison,'.png'])
        else
            savefig(fig,['comparisons\plots\',comparison,'_.fig'])
            saveas(fig,['comparisons\plots\',comparison,'.svg'])
            saveas(fig,['comparisons\plots\',comparison,'.png'])
        end
    end

% end